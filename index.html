<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<title>YoRadio Web Flasher</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<style>
  body{font-family:Arial,Helvetica,sans-serif;background:#f5f5f5;color:#222;padding:30px;text-align:center;}
  h1{color:#0b78c6}
  .buttons{margin:20px 0}
  button{background:#0b78c6;color:#fff;border:none;padding:12px 20px;border-radius:8px;font-size:16px;margin:6px;cursor:pointer}
  button:disabled{background:#ccc;color:#666;cursor:not-allowed}
  #status{font-weight:bold;margin:12px}
  #progress-wrap{width:80%;max-width:900px;margin:12px auto;background:#e0e0e0;border-radius:8px;height:18px;overflow:hidden}
  #progress{height:100%;width:0%;background:#4caf50;transition:width .2s}
  pre#log{width:80%;max-width:900px;margin:12px auto;padding:12px;background:#fff;border:1px solid #ddd;border-radius:8px;text-align:left;height:260px;overflow:auto;font-family:monospace}
</style>
</head>
<body>
  <h1>YoRadio Web Flasher</h1>
  <p>–ü–æ–¥–∫–ª—é—á–∏—Ç–µ ESP –∏ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ —à–∞–≥–∏: –≤—ã–±–µ—Ä–∏—Ç–µ –ø–æ—Ä—Ç ‚Üí –ø–æ–¥–∫–ª—é—á–∏—Ç–µ—Å—å ‚Üí –ø—Ä–æ—à–µ–π—Ç–µ</p>

  <div class="buttons">
    <button id="btnSelect">1. –í—ã–±—Ä–∞—Ç—å –ø–æ—Ä—Ç</button>
    <button id="btnConnect" disabled>2. –ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è</button>
    <button id="btnFlash" disabled>3. –ü—Ä–æ—à–∏—Ç—å</button>
  </div>

  <div id="status">–°—Ç–∞—Ç—É—Å: –æ–∂–∏–¥–∞–Ω–∏–µ</div>

  <div id="progress-wrap"><div id="progress"></div></div>

  <pre id="log">–õ–æ–≥:\n</pre>

<script>
/* ====== –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –ø—Ä–æ—à–∏–≤–∫–∏ (–∏–º–µ–Ω–∞ —Ñ–∞–π–ª–æ–≤ –∏ –∞–¥—Ä–µ—Å–∞) ======
   –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —ç—Ç–∏ —Ñ–∞–π–ª—ã –∑–∞–≥—Ä—É–∂–µ–Ω—ã –≤ —Ç–æ—Ç –∂–µ –∫–∞—Ç–∞–ª–æ–≥, —á—Ç–æ –∏ index.html */
const FILES = [
  { name: 'bootloader.bin', address: 0x0 },
  { name: 'partitions.bin', address: 0x8000 },
  { name: 'firmware.bin', address: 0x10000 },
  { name: 'spiffs.bin', address: 0x3d0000 }
];

const logEl = document.getElementById('log');
const statusEl = document.getElementById('status');
const progressEl = document.getElementById('progress');
const btnSelect = document.getElementById('btnSelect');
const btnConnect = document.getElementById('btnConnect');
const btnFlash = document.getElementById('btnFlash');

let selectedPort = null;
let transport = null;
let loader = null;

function log(msg){
  const t = new Date().toLocaleTimeString();
  logEl.textContent += `[${t}] ${msg}\n`;
  logEl.scrollTop = logEl.scrollHeight;
  console.log(msg);
}
function setStatus(s){ statusEl.textContent = '–°—Ç–∞—Ç—É—Å: ' + s; }
function setProgress(p){ progressEl.style.width = (Math.max(0, Math.min(100,p))) + '%'; }

async function loadScript(url){
  return new Promise((res, rej) => {
    const s = document.createElement('script');
    s.src = url;
    s.onload = () => res(url);
    s.onerror = () => rej(new Error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ ' + url));
    document.head.appendChild(s);
  });
}

async function ensureEsptoolJS(){
  // –ü–æ–ø—ã—Ç–∞–µ–º—Å—è –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π bundle, –∑–∞—Ç–µ–º –∑–∞–ø–∞—Å–Ω–æ–π –ø—É—Ç—å
  if (window.ESPLoader && window.Transport) {
    log('esptool-js —É–∂–µ –∑–∞–≥—Ä—É–∂–µ–Ω –≤ –æ–∫–Ω–æ.');
    return;
  }
  try {
    log('–ó–∞–≥—Ä—É–∂–∞—é esptool-js (bundle.js)...');
    await loadScript('https://unpkg.com/esptool-js/bundle.js');
  } catch(e){
    log('bundle.js –Ω–µ –∑–∞–≥—Ä—É–∑–∏–ª—Å—è, –ø—Ä–æ–±—É—é lib/index.js...');
    try {
      await loadScript('https://unpkg.com/esptool-js/lib/index.js');
    } catch(e2){
      log('‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å esptool-js —Å CDN: ' + e2.message);
      throw e2;
    }
  }
  // –µ—â—ë —Ä–∞–∑ –ø—Ä–æ–≤–µ—Ä–∏–º
  if (!(window.ESPLoader || (window.esptool && window.esptool.ESPLoader))){
    throw new Error('esptool-js –∑–∞–≥—Ä—É–∂–µ–Ω, –Ω–æ ESPLoader –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω (–Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —ç–∫—Å–ø–æ—Ä—Ç). –û—Ç–∫—Ä–æ–π—Ç–µ –∫–æ–Ω—Å–æ–ª—å —Å–µ—Ç–∏, –ø–æ—Å–º–æ—Ç—Ä–∏—Ç–µ, —á—Ç–æ –∑–∞–≥—Ä—É–∑–∏–ª–æ—Å—å.');
  }
  log('‚úÖ esptool-js –¥–æ—Å—Ç—É–ø–µ–Ω.');
}

/* ---- 1. –í—ã–±—Ä–∞—Ç—å –ø–æ—Ä—Ç ---- */
btnSelect.addEventListener('click', async () => {
  try {
    if (!navigator.serial) {
      setStatus('Web Serial API –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –≤ —ç—Ç–æ–º –±—Ä–∞—É–∑–µ—Ä–µ');
      log('‚ö†Ô∏è –í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç Web Serial API. –û—Ç–∫—Ä–æ–π—Ç–µ Chrome/Edge.');
      return;
    }
    log('–û—Ç–∫—Ä—ã–≤–∞—é –¥–∏–∞–ª–æ–≥ –≤—ã–±–æ—Ä–∞ –ø–æ—Ä—Ç–∞...');
    selectedPort = await navigator.serial.requestPort();
    const info = selectedPort.getInfo ? selectedPort.getInfo() : {};
    log('–ü–æ—Ä—Ç –≤—ã–±—Ä–∞–Ω: ' + (info.usbVendorId ? ('VID:0x' + info.usbVendorId.toString(16)) : 'unknown'));
    setStatus('–ü–æ—Ä—Ç –≤—ã–±—Ä–∞–Ω');
    btnConnect.disabled = false;
  } catch (e) {
    log('–ü–æ—Ä—Ç –Ω–µ –≤—ã–±—Ä–∞–Ω: ' + (e && e.message ? e.message : e));
  }
});

/* ---- 2. –ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è ---- */
btnConnect.addEventListener('click', async () => {
  try {
    setStatus('–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ: –∑–∞–≥—Ä—É–∂–∞—é –±–∏–±–ª–∏–æ—Ç–µ–∫—É...');
    await ensureEsptoolJS();

    if (!selectedPort) throw new Error('–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –ø–æ—Ä—Ç.');

    log('–°–æ–∑–¥–∞—ë–º Transport –∏ –æ—Ç–∫—Ä—ã–≤–∞–µ–º –ø–æ—Ä—Ç...');
    const TransportClass = window.Transport || (window.esptool && window.esptool.Transport);
    if (!TransportClass) throw new Error('Transport –∫–ª–∞—Å—Å –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ esptool-js.');

    transport = new TransportClass(selectedPort, false, true);
    // –æ—Ç–∫—Ä—ã–≤–∞–µ–º –ø–æ—Ä—Ç (115200 –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)
    await transport.connect(115200);
    log('‚úÖ Serial –æ—Ç–∫—Ä—ã—Ç.');

    // ESPLoader: –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º —Ä–∞–∑–Ω—ã–µ —Å–∏–≥–Ω–∞—Ç—É—Ä—ã –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä–∞
    const LoaderClass = window.ESPLoader || (window.esptool && window.esptool.ESPLoader);
    if (!LoaderClass) throw new Error('ESPLoader –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ esptool-js.');

    try {
      // —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç: –æ–±—ä–µ–∫—Ç –æ–ø—Ü–∏–π
      loader = new LoaderClass({ transport: transport, baudrate: 115200 });
    } catch (e) {
      // —Å—Ç–∞—Ä—ã–π –≤–∞—Ä–∏–∞–Ω—Ç: –ø–æ–∑–∏—Ü–∏–æ–Ω–Ω—ã–µ –∞—Ä–≥—É–º–µ–Ω—Ç—ã
      loader = new LoaderClass(transport, 115200);
    }

    log('–ü—ã—Ç–∞—é—Å—å —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å–≤—è–∑—å —Å —á–∏–ø–æ–º (enter bootloader) ...');
    // –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ ‚Äî –º–µ—Ç–æ–¥ connect
    if (typeof loader.connect === 'function') {
      await loader.connect();
      log('‚úÖ –°–≤—è–∑—å —Å —á–∏–ø–æ–º —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞.');
      setStatus('–ü–æ–¥–∫–ª—é—á–µ–Ω–æ');
      btnFlash.disabled = false;
    } else {
      throw new Error('–ú–µ—Ç–æ–¥ connect –Ω–µ –Ω–∞–π–¥–µ–Ω —É ESPLoader.');
    }
  } catch (e) {
    console.error(e);
    log('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–∏: ' + (e && e.message ? e.message : e));
    setStatus('–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è');
    btnFlash.disabled = true;
  }
});

/* Helper: Uint8Array -> base64 (chunked, —á—Ç–æ–±—ã –Ω–µ —É–ø–∞—Å—Ç—å –Ω–∞ –±–æ–ª—å—à–∏—Ö —Ñ–∞–π–ª–∞—Ö) */
function uint8ToBase64(u8) {
  const CHUNK = 0x8000;
  let str = '';
  for (let i = 0; i < u8.length; i += CHUNK) {
    const sub = u8.subarray(i, i + CHUNK);
    str += String.fromCharCode.apply(null, sub);
  }
  return btoa(str);
}

/* ---- 3. –ü—Ä–æ—à–∏—Ç—å ---- */
btnFlash.addEventListener('click', async () => {
  try {
    if (!loader) throw new Error('–°–Ω–∞—á–∞–ª–∞ –ø–æ–¥–∫–ª—é—á–∏—Ç–µ—Å—å –∫ —É—Å—Ç—Ä–æ–π—Å—Ç–≤—É.');

    log('\n=== –ù–∞—á–∏–Ω–∞—é –ø—Ä–æ—à–∏–≤–∫—É ===');
    setStatus('–ü—Ä–æ—à–∏–≤–∫–∞...');
    setProgress(0);
    // –ó–∞–≥—Ä—É–∂–∞–µ–º –≤—Å–µ —Ñ–∞–π–ª—ã
    const fileArray = [];
    let totalBytes = 0;
    for (const f of FILES) {
      log(`–ó–∞–≥—Ä—É–∂–∞—é ${f.name}...`);
      const resp = await fetch(f.name);
      if (!resp.ok) throw new Error(`–§–∞–π–ª ${f.name} –Ω–µ –Ω–∞–π–¥–µ–Ω –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ (status ${resp.status})`);
      const ab = await resp.arrayBuffer();
      const u8 = new Uint8Array(ab);
      totalBytes += u8.length;
      const b64 = uint8ToBase64(u8);
      fileArray.push({ address: f.address, data: b64 });
      log(`‚úÖ ${f.name} (${u8.length} –±–∞–π—Ç)`);
    }

    log('–ü–µ—Ä–µ–¥–∞—é –¥–∞–Ω–Ω—ã–µ –≤ –∑–∞–≥—Ä—É–∑—á–∏–∫...');
    // –í—ã–∑–æ–≤ writeFlash: —Å–º. –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å FlashOptions
    await loader.writeFlash({
      fileArray: fileArray,
      flashSize: 'keep',
      // reportProgress –º–æ–∂–µ—Ç –ø—Ä–∏–Ω–∏–º–∞—Ç—å (fileIndex, written, total)
      reportProgress: (fileIndex, written, total) => {
        const percent = Math.floor((written / total) * 100);
        setProgress(percent);
        setStatus(`–ü—Ä–æ—à–∏–≤–∫–∞: ${percent}% (—Ñ–∞–π–ª ${fileIndex + 1}/${fileArray.length})`);
        log(`–ü—Ä–æ–≥—Ä–µ—Å—Å: ${percent}% (—Ñ–∞–π–ª ${fileIndex + 1}/${fileArray.length})`);
      },
      compress: false,
      eraseAll: false
    });

    setProgress(100);
    setStatus('–ì–æ—Ç–æ–≤–æ');
    log('üéâ –ü—Ä–æ—à–∏–≤–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ!');
  } catch (e) {
    console.error(e);
    log('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–æ—à–∏–≤–∫–∏: ' + (e && e.message ? e.message : e));
    setStatus('–û—à–∏–±–∫–∞ –ø—Ä–æ—à–∏–≤–∫–∏');
  } finally {
    // –Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ: –æ—Å—Ç–∞–≤–ª—è–µ–º –ø–æ—Ä—Ç –æ—Ç–∫—Ä—ã—Ç—ã–º, —á—Ç–æ–±—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–≥ —Å–º–æ—Ç—Ä–µ—Ç—å –ª–æ–≥–∏.
  }
});

/* –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è */
(function init(){
  log('–°—Ç—Ä–∞–Ω–∏—Ü–∞ –≥–æ—Ç–æ–≤–∞. –ù–∞–∂–º–∏—Ç–µ "–í—ã–±—Ä–∞—Ç—å –ø–æ—Ä—Ç".');
  if (!navigator.serial) {
    log('‚ö†Ô∏è Web Serial API –Ω–µ –¥–æ—Å—Ç—É–ø–µ–Ω –≤ —ç—Ç–æ–º –±—Ä–∞—É–∑–µ—Ä–µ. –û—Ç–∫—Ä–æ–π—Ç–µ Chrome –∏–ª–∏ Edge.');
    setStatus('–ë—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è');
    btnSelect.disabled = true;
    btnConnect.disabled = true;
    btnFlash.disabled = true;
  }
})();
</script>
</body>
</html>
