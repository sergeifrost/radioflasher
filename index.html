<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>YoRadio Web Flasher</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f5f5f5;
      color: #333;
      text-align: center;
      padding: 40px;
    }
    h1 {
      color: #0077cc;
    }
    button {
      background: #0077cc;
      color: #fff;
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      cursor: pointer;
      margin: 10px;
    }
    button:hover {
      background: #005fa3;
    }
    button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    #progress-container {
      width: 80%;
      margin: 20px auto;
      background: #ddd;
      border-radius: 8px;
      overflow: hidden;
    }
    #progress-bar {
      height: 24px;
      width: 0%;
      background: #4caf50;
      transition: width 0.3s;
    }
    #log {
      text-align: left;
      margin: 20px auto;
      width: 80%;
      padding: 10px;
      background: #fff;
      border: 1px solid #ccc;
      border-radius: 8px;
      height: 200px;
      overflow-y: auto;
      font-family: monospace;
      font-size: 13px;
    }
    .status {
      margin: 10px;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <h1>YoRadio Web Flasher</h1>
  <p>–ü–æ–¥–∫–ª—é—á–∏—Ç–µ ESP32/ESP8266 –∏ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏—è –ø–æ –ø–æ—Ä—è–¥–∫—É:</p>
  
  <div>
    <button id="selectPort">1. –í—ã–±—Ä–∞—Ç—å –ø–æ—Ä—Ç</button>
    <button id="connect" disabled>2. –ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è</button>
    <button id="flash" disabled>3. –ü—Ä–æ—à–∏—Ç—å</button>
  </div>

  <div class="status" id="status">–°—Ç–∞—Ç—É—Å: –í—ã–±–µ—Ä–∏—Ç–µ –ø–æ—Ä—Ç</div>

  <div id="progress-container">
    <div id="progress-bar"></div>
  </div>

  <pre id="log"></pre>

  <!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º esptool-js -->
  <script src="https://cdn.jsdelivr.net/npm/esptool-js@0.1.4/dist/esptool-js.js"></script>
  
  <script>
    const files = [
      { offset: 0x0,       name: "bootloader.bin" },
      { offset: 0x8000,    name: "partitions.bin" },
      { offset: 0x10000,   name: "firmware.bin" },
      { offset: 0x3D0000,  name: "spiffs.bin" }
    ];

    const logEl = document.getElementById("log");
    const progressBar = document.getElementById("progress-bar");
    const statusEl = document.getElementById("status");
    const selectPortBtn = document.getElementById("selectPort");
    const connectBtn = document.getElementById("connect");
    const flashBtn = document.getElementById("flash");

    let selectedPort = null;
    let esptool = null;

    function log(msg) {
      logEl.textContent += msg + "\n";
      logEl.scrollTop = logEl.scrollHeight;
    }

    function setProgress(percent) {
      progressBar.style.width = percent + "%";
    }

    function setStatus(msg) {
      statusEl.textContent = "–°—Ç–∞—Ç—É—Å: " + msg;
    }

    function updateButtons() {
      connectBtn.disabled = !selectedPort;
      flashBtn.disabled = !esptool;
    }

    // 1. –í—ã–±–æ—Ä –ø–æ—Ä—Ç–∞
    selectPortBtn.addEventListener("click", async () => {
      try {
        log("üîå –í—ã–±–æ—Ä –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ–≥–æ –ø–æ—Ä—Ç–∞...");
        
        if (!navigator.serial) {
          throw new Error("Web Serial API –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ Chrome –∏–ª–∏ Edge.");
        }

        selectedPort = await navigator.serial.requestPort();
        log("‚úÖ –ü–æ—Ä—Ç –≤—ã–±—Ä–∞–Ω: " + (selectedPort.getInfo().usbProductId || "Unknown"));
        setStatus("–ü–æ—Ä—Ç –≤—ã–±—Ä–∞–Ω");
        updateButtons();
        
      } catch (e) {
        if (e.name === 'NotFoundError') {
          log("‚ùå –ü–æ—Ä—Ç –Ω–µ –≤—ã–±—Ä–∞–Ω");
        } else {
          log("‚ùå –û—à–∏–±–∫–∞ –≤—ã–±–æ—Ä–∞ –ø–æ—Ä—Ç–∞: " + e.message);
        }
        console.error(e);
      }
    });

    // 2. –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —É—Å—Ç—Ä–æ–π—Å—Ç–≤—É
    connectBtn.addEventListener("click", async () => {
      try {
        log("üîó –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —É—Å—Ç—Ä–æ–π—Å—Ç–≤—É...");
        setStatus("–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ");
        
        if (!selectedPort) {
          throw new Error("–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –ø–æ—Ä—Ç");
        }

        esptool = new EspTool();
        await esptool.initialize(selectedPort);
        
        log("‚úÖ –£—Å–ø–µ—à–Ω–æ –ø–æ–¥–∫–ª—é—á–µ–Ω–æ –∫ ESP");
        setStatus("–ü–æ–¥–∫–ª—é—á–µ–Ω–æ");
        updateButtons();
        
      } catch (e) {
        log("‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è: " + e.message);
        setStatus("–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è");
        console.error(e);
        esptool = null;
        updateButtons();
      }
    });

    // 3. –ü—Ä–æ—à–∏–≤–∫–∞
    flashBtn.addEventListener("click", async () => {
      try {
        logEl.textContent = "";
        setProgress(0);
        log("üöÄ –ù–∞—á–∞–ª–æ –ø—Ä–æ—à–∏–≤–∫–∏...");
        setStatus("–ü—Ä–æ—à–∏–≤–∫–∞");

        if (!esptool) {
          throw new Error("–°–Ω–∞—á–∞–ª–∞ –ø–æ–¥–∫–ª—é—á–∏—Ç–µ—Å—å –∫ —É—Å—Ç—Ä–æ–π—Å—Ç–≤—É");
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–æ–≤ –ø—Ä–æ—à–∏–≤–∫–∏
        const fileData = {};
        for (let i = 0; i < files.length; i++) {
          const f = files[i];
          log(`üì• –ó–∞–≥—Ä—É–∑–∫–∞ ${f.name}...`);
          try {
            const resp = await fetch(f.name);
            if (!resp.ok) throw new Error(`–§–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω: ${resp.status}`);
            const data = new Uint8Array(await resp.arrayBuffer());
            fileData[f.offset] = data;
            log(`‚úÖ ${f.name} –∑–∞–≥—Ä—É–∂–µ–Ω`);
          } catch (e) {
            log(`‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ ${f.name}: ${e.message}`);
            throw e;
          }
        }

        // –ü—Ä–æ—Ü–µ—Å—Å –ø—Ä–æ—à–∏–≤–∫–∏
        await esptool.writeFlash({
          fileArray: fileData,
          flashSize: "keep",
          onProgress: (bytesWritten, totalBytes) => {
            const percent = Math.floor((bytesWritten / totalBytes) * 100);
            setProgress(percent);
            log(`–ü—Ä–æ–≥—Ä–µ—Å—Å: ${percent}%`);
          }
        });

        setProgress(100);
        log("üéâ –ü—Ä–æ—à–∏–≤–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ!");
        setStatus("–ì–æ—Ç–æ–≤–æ");
        
      } catch (e) {
        log("‚ùå –û—à–∏–±–∫–∞ –ø—Ä–æ—à–∏–≤–∫–∏: " + e.message);
        setStatus("–û—à–∏–±–∫–∞ –ø—Ä–æ—à–∏–≤–∫–∏");
        console.error(e);
      }
    });

    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∏ Web Serial API –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
    window.addEventListener('load', () => {
      if (!navigator.serial) {
        log("‚ö†Ô∏è Web Serial API –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –≤–∞—à–∏–º –±—Ä–∞—É–∑–µ—Ä–æ–º");
        log("‚ÑπÔ∏è –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ Chrome, Edge –∏–ª–∏ –¥—Ä—É–≥–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º—ã–π –±—Ä–∞—É–∑–µ—Ä");
        selectPortBtn.disabled = true;
        setStatus("–ë—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è");
      }
    });
  </script>
</body>
</html>