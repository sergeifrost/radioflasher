<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>YoRadio Web Flasher</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f5f5f5;
      color: #333;
      text-align: center;
      padding: 40px;
    }
    h1 {
      color: #0077cc;
    }
    button {
      background: #0077cc;
      color: #fff;
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      cursor: pointer;
      margin: 20px 0;
    }
    button:hover {
      background: #005fa3;
    }
    #progress-container {
      width: 80%;
      margin: 20px auto;
      background: #ddd;
      border-radius: 8px;
      overflow: hidden;
    }
    #progress-bar {
      height: 24px;
      width: 0%;
      background: #4caf50;
      transition: width 0.3s;
    }
    #log {
      text-align: left;
      margin: 20px auto;
      width: 80%;
      padding: 10px;
      background: #fff;
      border: 1px solid #ccc;
      border-radius: 8px;
      height: 200px;
      overflow-y: auto;
      font-family: monospace;
      font-size: 13px;
    }
  </style>
</head>
<body>
  <h1>YoRadio Web Flasher</h1>
  <p>–ü–æ–¥–∫–ª—é—á–∏—Ç–µ ESP32/ESP8266 –∏ –Ω–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –Ω–∏–∂–µ:</p>
  <button id="flash">–í—ã–±—Ä–∞—Ç—å –ø–æ—Ä—Ç –∏ –ø—Ä–æ—à–∏—Ç—å</button>

  <div id="progress-container">
    <div id="progress-bar"></div>
  </div>

  <pre id="log"></pre>

  <!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º esptool-js -->
  <script src="https://unpkg.com/esptool-js/bundle.js"></script>
  <script>
    const files = [
      { offset: 0x0,       name: "bootloader.bin" },
      { offset: 0x8000,    name: "partitions.bin" },
      { offset: 0x10000,   name: "firmware.bin" },
      { offset: 0x3D0000,  name: "spiffs.bin" }
    ];

    const logEl = document.getElementById("log");
    const progressBar = document.getElementById("progress-bar");

    function log(msg) {
      logEl.textContent += msg + "\n";
      logEl.scrollTop = logEl.scrollHeight;
    }

    function setProgress(percent) {
      progressBar.style.width = percent + "%";
    }

    document.getElementById("flash").addEventListener("click", async () => {
      try {
        logEl.textContent = "";
        setProgress(0);
        log("üîå –û–∂–∏–¥–∞–Ω–∏–µ –≤—ã–±–æ—Ä–∞ –ø–æ—Ä—Ç–∞...");
        const esptool = new ESPLoader();
        await esptool.initialize();
        log("‚úÖ –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ.");

        const fileData = {};
        for (let i = 0; i < files.length; i++) {
          const f = files[i];
          log(`üì• –ó–∞–≥—Ä—É–∑–∫–∞ ${f.name}...`);
          const resp = await fetch(f.name);
          const data = new Uint8Array(await resp.arrayBuffer());
          fileData[f.offset] = data;
        }

        log("üöÄ –ù–∞—á–∞–ª–æ –ø—Ä–æ—à–∏–≤–∫–∏...");
        await esptool.writeFlash({
          fileArray: fileData,
          flashSize: "keep",
          onProgress: (bytesWritten, totalBytes) => {
            const percent = Math.floor((bytesWritten / totalBytes) * 100);
            setProgress(percent);
          }
        });

        setProgress(100);
        log("üéâ –ü—Ä–æ—à–∏–≤–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!");
      } catch (e) {
        log("‚ùå –û—à–∏–±–∫–∞: " + e.message);
        console.error(e);
      }
    });
  </script>
</body>
</html>
