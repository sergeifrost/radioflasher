<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>YoRadio Web Flasher</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f5f5f5;
      color: #333;
      text-align: center;
      padding: 40px;
    }
    h1 {
      color: #0077cc;
    }
    button {
      background: #0077cc;
      color: #fff;
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      cursor: pointer;
      margin: 10px;
    }
    button:hover {
      background: #005fa3;
    }
    button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    #progress-container {
      width: 80%;
      margin: 20px auto;
      background: #ddd;
      border-radius: 8px;
      overflow: hidden;
    }
    #progress-bar {
      height: 24px;
      width: 0%;
      background: #4caf50;
      transition: width 0.3s;
    }
    #log {
      text-align: left;
      margin: 20px auto;
      width: 80%;
      padding: 10px;
      background: #fff;
      border: 1px solid #ccc;
      border-radius: 8px;
      height: 200px;
      overflow-y: auto;
      font-family: monospace;
      font-size: 13px;
    }
    .status {
      margin: 10px;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <h1>YoRadio Web Flasher</h1>
  <p>–ü–æ–¥–∫–ª—é—á–∏—Ç–µ ESP32/ESP8266 –∏ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ —à–∞–≥–∏:</p>
  
  <div>
    <button id="selectPort">1. –í—ã–±—Ä–∞—Ç—å –ø–æ—Ä—Ç</button>
    <button id="connect" disabled>2. –ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è</button>
    <button id="flash" disabled>3. –ü—Ä–æ—à–∏—Ç—å</button>
  </div>

  <div class="status" id="status">–°—Ç–∞—Ç—É—Å: –æ–∂–∏–¥–∞–µ—Ç –¥–µ–π—Å—Ç–≤–∏—è</div>

  <div id="progress-container">
    <div id="progress-bar"></div>
  </div>

  <pre id="log"></pre>

  <!-- –ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ -->
  <script src="https://unpkg.com/esptool-js/bundle.js"></script>
  
  <script>
    const files = [
      { offset: 0x0,       name: "bootloader.bin" },
      { offset: 0x8000,    name: "partitions.bin" },
      { offset: 0x10000,   name: "firmware.bin" },
      { offset: 0x3D0000,  name: "spiffs.bin" }
    ];

    const logEl = document.getElementById("log");
    const progressBar = document.getElementById("progress-bar");
    const statusEl = document.getElementById("status");
    const selectPortBtn = document.getElementById("selectPort");
    const connectBtn = document.getElementById("connect");
    const flashBtn = document.getElementById("flash");

    let selectedPort = null;
    let esploader = null;

    function log(msg) {
      logEl.textContent += msg + "\n";
      logEl.scrollTop = logEl.scrollHeight;
    }

    function setProgress(percent) {
      progressBar.style.width = percent + "%";
    }

    function setStatus(msg) {
      statusEl.textContent = "–°—Ç–∞—Ç—É—Å: " + msg;
    }

    function updateButtons() {
      connectBtn.disabled = !selectedPort;
      flashBtn.disabled = !esploader;
    }

    // 1. –í—ã–±–æ—Ä –ø–æ—Ä—Ç–∞
    selectPortBtn.addEventListener("click", async () => {
      try {
        if (!navigator.serial) {
          throw new Error("Web Serial API –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ Chrome –∏–ª–∏ Edge.");
        }
        selectedPort = await navigator.serial.requestPort();
        log("‚úÖ –ü–æ—Ä—Ç –≤—ã–±—Ä–∞–Ω");
        setStatus("–ü–æ—Ä—Ç –≤—ã–±—Ä–∞–Ω");
        updateButtons();
      } catch (e) {
        log("‚ùå –û—à–∏–±–∫–∞ –≤—ã–±–æ—Ä–∞ –ø–æ—Ä—Ç–∞: " + e.message);
      }
    });

    // 2. –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ
    connectBtn.addEventListener("click", async () => {
      try {
        setStatus("–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...");
        log("üîó –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ ESP...");
        esploader = new esptool.EspLoader({ debug: true });
        await esploader.connect(selectedPort);
        log("‚úÖ –£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –ø–æ–¥–∫–ª—é—á–µ–Ω–æ");
        setStatus("–ü–æ–¥–∫–ª—é—á–µ–Ω–æ");
        updateButtons();
      } catch (e) {
        log("‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è: " + e.message);
        setStatus("–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è");
      }
    });

    // 3. –ü—Ä–æ—à–∏–≤–∫–∞
    flashBtn.addEventListener("click", async () => {
      try {
        log("üöÄ –ù–∞—á–∞–ª–æ –ø—Ä–æ—à–∏–≤–∫–∏...");
        setStatus("–ü—Ä–æ—à–∏–≤–∫–∞");
        setProgress(0);

        const fileData = {};
        let totalSize = 0;

        // –ó–∞–≥—Ä—É–∂–∞–µ–º –≤—Å–µ BIN-—Ñ–∞–π–ª—ã
        for (let f of files) {
          log(`üì• –ó–∞–≥—Ä—É–∑–∫–∞ ${f.name}...`);
          const resp = await fetch(f.name);
          if (!resp.ok) throw new Error(`–ù–µ –Ω–∞–π–¥–µ–Ω ${f.name}`);
          const data = new Uint8Array(await resp.arrayBuffer());
          fileData[f.offset] = data;
          totalSize += data.length;
          log(`‚úÖ ${f.name} –∑–∞–≥—Ä—É–∂–µ–Ω`);
        }

        let written = 0;
        await esploader.writeFlash({
          fileArray: fileData,
          flashSize: "keep",
          onProgress: (bytesWritten, totalBytes) => {
            written = bytesWritten;
            const percent = Math.floor((written / totalBytes) * 100);
            setProgress(percent);
            log(`–ü—Ä–æ–≥—Ä–µ—Å—Å: ${percent}%`);
          }
        });

        setProgress(100);
        log("üéâ –ü—Ä–æ—à–∏–≤–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ!");
        setStatus("–ì–æ—Ç–æ–≤–æ");
      } catch (e) {
        log("‚ùå –û—à–∏–±–∫–∞ –ø—Ä–æ—à–∏–≤–∫–∏: " + e.message);
        setStatus("–û—à–∏–±–∫–∞ –ø—Ä–æ—à–∏–≤–∫–∏");
      }
    });
  </script>
</body>
</html>
